#!/usr/bin/env bash
#
# extract - universal archive extractor with GUI notification
# usage: extract <archive-file>

set -euo pipefail

file="$1"

if [[ -z "${file:-}" ]]; then
    echo "Usage: extract <archive-file>"
    exit 1
fi

if [[ ! -f "$file" ]]; then
    echo "Error: '$file' is not a valid file"
    notify-send "Extraction Failed" "'$file' is not a valid file"
    exit 1
fi

# Normalize filename
filename="$(basename "$file")"
dirname="$(dirname "$file")"
# Strip multiple extensions like .tar.gz
outdir="${filename%%.*}"
ext="${filename#*.}"

# Improve folder name for common multi-extension types
case "$filename" in
    *.tar.gz)  outdir="${filename%.tar.gz}" ;;
    *.tar.bz2) outdir="${filename%.tar.bz2}" ;;
    *.tar.xz)  outdir="${filename%.tar.xz}" ;;
    *.tar.Z)   outdir="${filename%.tar.Z}" ;;
esac

# Create output directory
target="$dirname/$outdir"
mkdir -p "$target"

echo "Extracting '$filename' to '$target'..."

case "$filename" in
    *.tar.bz2)   tar xjf "$file" -C "$target" ;;
    *.tar.gz)    tar xzf "$file" -C "$target" ;;
    *.tar.xz)    tar xJf "$file" -C "$target" ;;
    *.bz2)       bunzip2 -c "$file" > "$target/${filename%.bz2}" ;;
    *.rar)       unrar e -o+ "$file" "$target" ;;
    *.gz)        gunzip -c "$file" > "$target/${filename%.gz}" ;;
    *.tar)       tar xf "$file" -C "$target" ;;
    *.tbz2)      tar xjf "$file" -C "$target" ;;
    *.tgz)       tar xzf "$file" -C "$target" ;;
    *.zip)       unzip -qq -d "$target" "$file" ;;
    *.Z)         uncompress -c "$file" > "$target/${filename%.Z}" ;;
    *.7z)        7z x -o"$target" "$file" >/dev/null ;;
    *)           echo "Error: '$filename' cannot be extracted via extract()"
                 notify-send "Extraction Failed" "'$filename' type not supported"
                 exit 1 ;;
esac

notify-send "Extraction Complete" "'$filename' extracted to '$outdir/'"
