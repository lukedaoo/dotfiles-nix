#!/usr/bin/env bash

# Ensure playerctl-loop is running
pidof -x playerctl-loop >/dev/null 2>&1 || playerctl-loop >/dev/null 2>&1 &

STATUS=$(2>/dev/null playerctl status)

# ICON can be adapted if you want a "Playing:" indicator
# [[ $STATUS == "Playing" ]] && ICON="Playing: " || ICON=" "
ICON=""

# Try to get metadata
TITLE=$(playerctl metadata --format '{{title}}' 2>/dev/null)
ARTIST=$(playerctl metadata --format '{{artist}}' 2>/dev/null)

# Fallback: extract filename (strip path + extension) if title is empty
if [ -z "$TITLE" ]; then
    FILENAME=$(playerctl metadata --format '{{xesam:url}}' 2>/dev/null \
        | sed 's#.*/##; s/\.[^.]*$//')
    TITLE="$FILENAME"
    ARTIST=""
fi

# Truncate for display
NORMAL=$(printf "%.10s" "$TITLE")
if [ -n "$ARTIST" ]; then
    ALTERNATE="$(printf "%.10s" "$ARTIST") - $(printf "%.10s" "$TITLE")"
else
    ALTERNATE="$NORMAL"
fi

FORMAT_FILE="/tmp/dwmblocks_mus_format"
[ ! -f "$FORMAT_FILE" ] && echo "0" > "$FORMAT_FILE"
read FORMAT < "$FORMAT_FILE"

case $BUTTON in
    1) echo "$(( (FORMAT + 1) % 2 ))" > "$FORMAT_FILE" ;;
    3) playerctl play-pause; pkill -RTMIN+11 "${STATUSBAR:-dwmblocks}" ;;
    # 3) setsid -w -f "$TERMINAL" -e alsamixer; pkill -RTMIN+11 "${STATUSBAR:-dwmblocks}" ;;
esac

[ "$FORMAT" -eq 0 ] && INFO="$NORMAL" || INFO="$ALTERNATE"

echo -e "$ICON$INFO"
