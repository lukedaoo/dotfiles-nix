#!/usr/bin/env bash

# Ensure playerctl-loop is running
pidof -x playerctl-loop >/dev/null 2>&1 || playerctl-loop >/dev/null 2>&1 &

# Prioritize MPD first, then Chromium/Chrome
PLAYER=""
for P in mpd chromium; do
    if playerctl -l 2>/dev/null | grep -q "^$P$"; then
        PLAYER="$P"
        break
    fi
done

# If no player is running, show idle
if [ -z "$PLAYER" ]; then
    INDICATOR="(idle)"
    INFO=""
    echo -e "$INDICATOR$INFO"
    exit 0
fi

# Get playback status
STATUS=$(playerctl -p "$PLAYER" status 2>/dev/null)

# Text indicators
case "$STATUS" in
    "Playing") INDICATOR="(playing) " ;;
    "Paused")  INDICATOR="(pause) " ;;
    *)         INDICATOR="(idle)" ;;
esac

# Get metadata
TITLE=$(playerctl -p "$PLAYER" metadata --format '{{title}}' 2>/dev/null)
ARTIST=$(playerctl -p "$PLAYER" metadata --format '{{artist}}' 2>/dev/null)

# Fallback: extract filename (strip path + extension) if title is empty
if [ -z "$TITLE" ]; then
    FILENAME=$(playerctl -p "$PLAYER" metadata --format '{{xesam:url}}' 2>/dev/null \
        | sed 's#.*/##; s/\.[^.]*$//')
    TITLE="$FILENAME"
    ARTIST=""
fi

# Truncate for display
NORMAL=$(printf "%.10s" "$TITLE")
if [ -n "$ARTIST" ]; then
    ALTERNATE="$(printf "%.10s" "$ARTIST") - $(printf "%.10s" "$TITLE")"
else
    ALTERNATE="$NORMAL"
fi

FORMAT_FILE="/tmp/dwmblocks_mus_format"
[ ! -f "$FORMAT_FILE" ] && echo "0" > "$FORMAT_FILE"
read FORMAT < "$FORMAT_FILE"

case $BUTTON in
    1) echo "$(( (FORMAT + 1) % 2 ))" > "$FORMAT_FILE" ;;
    3) playerctl -p "$PLAYER" play-pause; pkill -RTMIN+11 "${STATUSBAR:-dwmblocks}" ;;
esac

[ "$FORMAT" -eq 0 ] && INFO="$NORMAL" || INFO="$ALTERNATE"

echo -e "$INDICATOR$INFO"
